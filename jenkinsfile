pipeline {
    agent any
    // parameters {
    //     string(name: 'String_TAG', defaultValue: '', description: 'Tag de test')
    //     choice(name: 'CHOICE_TAG', choices: ['@valid', '@invalid', '@Integration', '@Post'], description: 'SÃ©lectionne un tag de test')
    // }
    stages {
        stage('Build and Install') {
            agent {
                docker {
                    image 'mcr.microsoft.com/playwright:v1.51.0-noble'
                }
            }
            steps {
                script {
                sh 'apt-get update && apt-get install -y nodejs npm'
                sh 'node -v'
                sh 'npm -v'
                    sh 'npm ci'
                }
            }
        }
       
        stage('Tests Fonctionnels') {
            parallel {
                stage('Login Tests') {
                    steps {
                        sh "npx cucumber-js features/login.feature --format json:reports/login-report.json --parallel 4"
                    }
                }
                stage('Checkout Tests') {
                    steps {
                        sh "npx cucumber-js features/checkout.feature --format json:reports/checkout-report.json --parallel 4"
                    }
                }
                stage('API Tests') {
                    steps {
                        sh "npx cucumber-js features/api.feature --format json:reports/api-report.json --parallel 4"
                    }
                }
            }
        }
    }
    
    post {
        always {
            cucumber buildStatus: 'UNSTABLE',
                    failedFeaturesNumber: 1,
                    failedScenariosNumber: 1,
                    skippedStepsNumber: 1,
                    failedStepsNumber: 1,
                    classifications: [
                            [key: 'Commit', value: '<a href=\"${GERRIT_CHANGE_URL}\">${GERRIT_PATCHSET_REVISION}</a>'],
                            [key: 'Submitter', value: '${GERRIT_PATCHSET_UPLOADER_NAME}']
                    ],
                    reportTitle: 'My report',
                    fileIncludePattern: 'reports/*.json',
                    sortingMethod: 'ALPHABETICAL',
                    trendsLimit: 100
        }
    }
}
